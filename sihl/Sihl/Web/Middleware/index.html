<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Middleware (sihl.Sihl.Web.Middleware)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../../index.html">sihl</a> &#x00BB; <a href="../../index.html">Sihl</a> &#x00BB; <a href="../index.html">Web</a> &#x00BB; Middleware</nav><h1>Module <code>Web.Middleware</code></h1></header><dl><dt class="spec value" id="val-authentication_session"><a href="#val-authentication_session" class="anchor"></a><code><span class="keyword">val</span> authentication_session : <span>?&#8288;key:Stdlib.String.t</span> <span>&#45;&gt;</span> <span>?&#8288;error_handler:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><a href="../index.html#module-Response">Response</a>.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>(<span>email:string</span> <span>&#45;&gt;</span> <span>password:string</span> <span>&#45;&gt;</span> <span><span><span>(<a href="../../../Sihl__/Contract_user/index.html#type-t">Sihl__.Contract_user.t</a>, <span class="type-var">'a</span>)</span> Stdlib.result</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-authentication_token"><a href="#val-authentication_token" class="anchor"></a><code><span class="keyword">val</span> authentication_token : <span>?&#8288;key:string</span> <span>&#45;&gt;</span> <span>?&#8288;error_handler:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><a href="../index.html#module-Response">Response</a>.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>(<span>email:string</span> <span>&#45;&gt;</span> <span>password:string</span> <span>&#45;&gt;</span> <span><span><span>(<a href="../../../Sihl__/Contract_user/index.html#type-t">Sihl__.Contract_user.t</a>, <span class="type-var">'a</span>)</span> Stdlib.result</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span>(<span><span>(string * string)</span> list</span> <span>&#45;&gt;</span> <span>string Lwt.t</span>)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-authorization_user"><a href="#val-authorization_user" class="anchor"></a><code><span class="keyword">val</span> authorization_user : <span>login_path_f:<span>(unit <span>&#45;&gt;</span> string)</span></span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-authorization_admin"><a href="#val-authorization_admin" class="anchor"></a><code><span class="keyword">val</span> authorization_admin : <span>login_path_f:<span>(unit <span>&#45;&gt;</span> string)</span></span> <span>&#45;&gt;</span> <span>(<a href="../../../Sihl__/Contract_user/index.html#type-t">Sihl__.Contract_user.t</a> <span>&#45;&gt;</span> bool)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-bearer_token"><a href="#val-bearer_token" class="anchor"></a><code><span class="keyword">val</span> bearer_token : Rock.Middleware.t</code></dt></dl><aside><p><code>csrf ?not_allowed_handler ?cookie_key ?secret ()</code> returns a middleware that enables CSRF protection for unsafe HTTP requests.</p><p><code>not_allowed_handler</code> is used if an unsafe request does not pass the CSRF protection check. By default, <code>not_allowed_handler</code> returns an empty response with status 403.</p><p><code>cookie_key</code> is the key in the cookie under which a CSRF token will be stored. By default, <code>cookie_key</code> has a <code>__Host</code> prefix to increase cookie security. One important consequence of this prefix is, that the cookie cannot be sent across unencrypted (HTTP) connections. You should only set this argument if you know what you are doing and aware of the consequences.</p><p><code>secret</code> is the secret used to hash the CSRF cookie value with. By default, <code>SIHL_SECRET</code> is used.</p><p>Internally, the CSRF protection is implemented as the Double Submit Cookie approach.</p></aside><dl><dt class="spec value" id="val-csrf"><a href="#val-csrf" class="anchor"></a><code><span class="keyword">val</span> csrf : <span>?&#8288;not_allowed_handler:<span>(Rock.Request.t <span>&#45;&gt;</span> <span>Rock.Response.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;cookie_key:string</span> <span>&#45;&gt;</span> <span>?&#8288;secret:string</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-error"><a href="#val-error" class="anchor"></a><code><span class="keyword">val</span> error : <span>?&#8288;email_config:<span>(string * string * <span>(<a href="../../../Sihl__/Contract_email/index.html#type-t">Sihl__.Contract_email.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;reporter:<span>(string <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;error_handler:<span>(Rock.Request.t <span>&#45;&gt;</span> <span>Rock.Response.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>error ?email_config ?reporter ?handler ()</code> returns a middleware that catches all exceptions and shows them.</p><p>By default, it logs the exception with the request details. The response is either `text/html` or `application/json`, depending on the `Content-Type` header of the request. If SIHL_ENV is `development`, a more detailed debugging page is shown which makes development easier. You can override the error page/JSON that is shown by providing a custom error handler <code>error_handler</code>.</p><p>Optional email configuration <code>email_config</code> can be specified, which is a tuple (sender, recipient, send_function). Exceptions that are caught will be sent per email to <code>recipient</code> where <code>sender</code> is the sender of the email. Pass in the send function of the Sihl email service or provide your own <code>send_function</code>. An email will only be sent if SIHL_ENV is `production`.</p><p>An optional custom reporter <code>reporter</code> can be defined. The middleware passes the stringified exception as first argument to the reporter callback. Use the reporter to implement custom error reporting.</p></dd></dl><dl><dt class="spec value" id="val-flash"><a href="#val-flash" class="anchor"></a><code><span class="keyword">val</span> flash : <span>?&#8288;cookie_key:string</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-form"><a href="#val-form" class="anchor"></a><code><span class="keyword">val</span> form : Rock.Middleware.t</code></dt><dt class="spec value" id="val-htmx"><a href="#val-htmx" class="anchor"></a><code><span class="keyword">val</span> htmx : Rock.Middleware.t</code></dt><dt class="spec value" id="val-id"><a href="#val-id" class="anchor"></a><code><span class="keyword">val</span> id : Rock.Middleware.t</code></dt><dt class="spec value" id="val-json"><a href="#val-json" class="anchor"></a><code><span class="keyword">val</span> json : Rock.Middleware.t</code></dt><dt class="spec value" id="val-session"><a href="#val-session" class="anchor"></a><code><span class="keyword">val</span> session : <span>?&#8288;cookie_key:string</span> <span>&#45;&gt;</span> <span>?&#8288;secret:string</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-static_file"><a href="#val-static_file" class="anchor"></a><code><span class="keyword">val</span> static_file : unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-user_session"><a href="#val-user_session" class="anchor"></a><code><span class="keyword">val</span> user_session : <span>?&#8288;key:string</span> <span>&#45;&gt;</span> <span>(<span>user_id:string</span> <span>&#45;&gt;</span> <span><span><a href="../../../Sihl__/Contract_user/index.html#type-t">Sihl__.Contract_user.t</a> option</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dt class="spec value" id="val-user_token"><a href="#val-user_token" class="anchor"></a><code><span class="keyword">val</span> user_token : <span>?&#8288;key:string</span> <span>&#45;&gt;</span> <span>?&#8288;invalid_token_handler:<span>(Rock.Request.t <span>&#45;&gt;</span> <span>Rock.Response.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>(string <span>&#45;&gt;</span> <span>k:string</span> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> option</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span>(<span>user_id:<span class="type-var">'a</span></span> <span>&#45;&gt;</span> <span><span><a href="../../../Sihl__/Contract_user/index.html#type-t">Sihl__.Contract_user.t</a> option</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span>(string <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt></dl></div></body></html>