<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Configuration (sihl.Configuration)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">sihl</a> &#x00BB; Configuration</nav><h1>Module <code>Configuration</code></h1><p>An app’s configuration is everything that is likely to vary between deploys (staging, production, developer environments, etc).</p><p>This includes:</p><ul><li>Resource handles to the database, Memcached, and other backing services</li><li>Credentials to external services such as Amazon S3 or Twitter</li><li>Per-deploy values such as the canonical hostname for the deploy</li></ul><p>(Source: <a href="https://12factor.net/config">https://12factor.net/config</a>)</p><p>These configurations should not be hard-coded into the source code.</p><nav class="toc"><ul><li><a href="#define">Define configuration</a></li><li><a href="#service-installation">Service Installation</a></li><li><a href="#usage">Usage</a></li><li><a href="#configuration-provider">Configuration Provider</a></li></ul></nav></header><section><header><h2 id="define"><a href="#define" class="anchor"></a>Define configuration</h2></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code><code> = <a href="../Configuration__/Config_core/index.html#type-t">Configuration__.Config_core.t</a></code></dt><dd><p>The configuration type that contains configurations for development, test and production environments. Sihl reads the right configurations according to the environment variable <code>SIHL_ENV</code>.</p></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>development:<span><a href="../Configuration__/Config_core/index.html#type-key_value">Configuration__.Config_core.key_value</a> Base.list</span></span> <span>&#45;&gt;</span> <span>test:<span><a href="../Configuration__/Config_core/index.html#type-key_value">Configuration__.Config_core.key_value</a> Base.list</span></span> <span>&#45;&gt;</span> <span>production:<span><a href="../Configuration__/Config_core/index.html#type-key_value">Configuration__.Config_core.key_value</a> Base.list</span></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>create ~development ~test ~production</code> is the configuration.</p><p>Example:</p><pre><code class="ml">let config =
  Sihl.Config.create
    ~development:
      [ (&quot;DATABASE_URL&quot;, &quot;mariadb://root:password@127.0.0.1:3306/dev&quot;) ]
    ~test:[ (&quot;DATABASE_URL&quot;, &quot;mariadb://root:password@127.0.0.1:3306/test&quot;) ]
    ~production:[]</code></pre></dd></dl></section><section><header><h2 id="service-installation"><a href="#service-installation" class="anchor"></a>Service Installation</h2><p>Use the provided <a href="../Configuration__/Config_service/Make/index.html"><code>Sihl.Config.Service.Make</code></a> to create a config service. You need to inject a <a href="../Log__/Log_service_sig/module-type-SERVICE/index.html"><code>Sihl.Log.Service.Sig.SERVICE</code></a>. Use the default implementation provided by Sihl:</p><pre><code class="ml">module Log = Sihl.Log.Service.Make ()
module Config = Sihl.Config.Service.Make (Log)</code></pre></header></section><section><header><h2 id="usage"><a href="#usage" class="anchor"></a>Usage</h2><p>Use the configuration service <a href="../Configuration__/Config_service_sig/module-type-SERVICE/index.html"><code>Sihl.Config.Service.Sig.SERVICE</code></a> to read configurations at run-time from various sources.</p></header></section><section><header><h2 id="configuration-provider"><a href="#configuration-provider" class="anchor"></a>Configuration Provider</h2><p>Most services need a configuration provider in the service setup file. Let's have a look at the SMTP email service.</p><pre><code class="ml">(* Email template service setup, is responsible for rendering emails *)
module EmailTemplateRepo =
  Sihl.Email.Service.Template.Repo.MakeMariaDb (Db) (Repo) (Migration)
module EmailTemplate = Sihl.Email.Service.Template.Make (EmailTemplateRepo)

(* The provided EnvConfigProvider reads configuratin from env variables *)
module EmailConfigProvider = Sihl.Email.Service.EnvConfigProvider

(* The email service requires a configuration provider. It uses it to 
   fetch configuration on its own. *)
module Email =
  Sihl.Email.Service.Make.Smtp(EmailTemplate, EmailConfigProvider)</code></pre><p>The type of `EmailConfigProvider` is different from service implementation to service implementation. The type of the config provider for SMTP is:</p><pre><code class="ml">val sender : Core.Ctx.t -&gt; (string, string) Lwt_result.t

val username : Core.Ctx.t -&gt; (string, string) Lwt_result.t

val password : Core.Ctx.t -&gt; (string, string) Lwt_result.t

val host : Core.Ctx.t -&gt; (string, string) Lwt_result.t

val port : Core.Ctx.t -&gt; (int option, string) Lwt_result.t

val start_tls : Core.Ctx.t -&gt; (bool, string) Lwt_result.t

val ca_dir : Core.Ctx.t -&gt; (string, string) Lwt_result.t</code></pre><p>Note that it returns the configuration asynchronously. This is not needed when reading environment variables, but it allows you to implement your own config provider that reads configuration from elsewhere in a non-blocking way.</p></header><div class="spec module" id="module-Service"><a href="#module-Service" class="anchor"></a><code><span class="keyword">module</span> Service = <a href="../Configuration__/index.html#module-Config_service">Configuration__.Config_service</a></code></div><dl><dt class="spec value" id="val-is_testing"><a href="#val-is_testing" class="anchor"></a><code><span class="keyword">val</span> is_testing : unit <span>&#45;&gt;</span> bool</code></dt><dd><dl><dt>deprecated</dt><dd></dd></dl></dd></dl><dl><dt class="spec value" id="val-read_string_default"><a href="#val-read_string_default" class="anchor"></a><code><span class="keyword">val</span> read_string_default : <span>default:string</span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string</code></dt><dd><dl><dt>deprecated</dt><dd></dd></dl></dd></dl></section></div></body></html>