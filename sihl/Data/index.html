<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Data (sihl.Data)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">sihl</a> &#x00BB; Data</nav><h1>Module <code>Data</code></h1><p>Use this module to query the database, implement and run migrations, clean repositories, turn HTTP queries into SQL queries or for sane entity identifier handling.</p><nav class="toc"><ul><li><a href="#installation">Installation</a></li><li><a href="#usage">Usage</a></li></ul></nav></header><section><header><h2 id="installation"><a href="#installation" class="anchor"></a>Installation</h2><p>The database service uses <a href="https://github.com/paurkedal/ocaml-caqti">https://github.com/paurkedal/ocaml-caqti</a> under the hood. Caqti can dynamically load the correct driver based on the <code>DATABASE_URL</code> (postgresql://).</p><p>Caqti supports following databases (caqti drivers):</p><ul><li>PostgreSQL (caqti-driver-postgresql)</li><li>MariaDB (caqti-driver-mariadb)</li><li>SQLite (caqti-driver-sqlite)</li></ul><pre><code class="ml">module Log = Sihl.Log.Service.Make ()
module Config = Sihl.Config.Service.Make (Log)
module Db = Sihl.Data.Db.Service.Make (Config) (Log)</code></pre><p>Install one of the drivers listed above.</p><p><code>opam install caqti-driver-postgresql</code></p><p>Add the driver to your <code>done</code> file:</p><p><code>caqti-driver-postgresql</code></p></header><div class="spec module" id="module-Db"><a href="#module-Db" class="anchor"></a><code><span class="keyword">module</span> Db = <a href="../Data__/index.html#module-Data_db">Data__.Data_db</a></code></div></section><section><header><h2 id="usage"><a href="#usage" class="anchor"></a>Usage</h2><p>Register the database middleware, so other services can query the database with the context that contains the database pool.</p><pre><code class="ml">module DbMiddleware = Sihl.Web.Middleware.Db.Make (Service.Db)
let middlewares = [
  DbMiddleware.m();
]</code></pre><p>The database service should be used mostly in repositories and not in services themselves.</p><p>pizza_order_repo.ml:</p><pre><code class="ml">module MakePostgreSql
    (DbService: Sihl.Data.Db.Service.Sig.SERVICE) : Pizza_order_sig.REPO =
struct

  let find_request =
    Caqti_request.find_opt Caqti_type.string Model.t
      {sql|
        SELECT
          uuid,
          customer,
          pizza,
          amount,
          status,
          confirmed,
          created_at,
          updated_at
        FROM pizza_orders
        WHERE pizza_orders.uuid = ?::uuid
        |sql}

  let find ctx ~id =
    DbService.query ctx (fun connection -&gt;
        let module Connection = (val connection : Caqti_lwt.CONNECTION) in
        Connection.find_opt get_request id
        |&gt; Lwt_result.map_err Caqti_error.show)

end</code></pre><p>pizza_order_service.ml:</p><pre><code class="ml">module Make
    (Repo: Pizza_order_sig.REPO) : Pizza_order_sig.SERVICE = struct

    let find ctx ~id = Repo.find ctx ~id
end</code></pre><p>Then you can use the service:</p><pre><code class="ml">module PizzaOrderRepo = Pizza_order_repo.MakePostgreSql (Service.Db)
module PizzaOrderService = Pizza_order_service.Make (PizzaOrderRepo)
let get_pizza_order =
  Sihl.Web.Route.get &quot;/pizza-orders/:id&quot; (fun ctx -&gt;
      Sihl.Web.Res.(html |&gt; set_body &quot;Hello!&quot;) |&gt; Lwt.return)
let get_pizza_order =
  Sihl.Web.Route.get &quot;/pizza-orders/:id&quot; (fun ctx -&gt;
      let id = Sihl.Web.Req.param ctx &quot;id&quot; in
      let pizza = PizzaOrderService.find ctx ~id in
      ...
      )</code></pre></header><div class="spec module" id="module-Repo"><a href="#module-Repo" class="anchor"></a><code><span class="keyword">module</span> Repo = <a href="../Data__/index.html#module-Data_repo">Data__.Data_repo</a></code></div><div class="spec module" id="module-Migration"><a href="#module-Migration" class="anchor"></a><code><span class="keyword">module</span> Migration = <a href="../Data__/index.html#module-Data_migration">Data__.Data_migration</a></code></div><div class="spec module" id="module-Ql"><a href="#module-Ql" class="anchor"></a><code><span class="keyword">module</span> Ql = <a href="../Data__/index.html#module-Data_ql">Data__.Data_ql</a></code></div><div class="spec module" id="module-View"><a href="#module-View" class="anchor"></a><code><span class="keyword">module</span> View = <a href="../Data__/index.html#module-Data_view">Data__.Data_view</a></code></div><div class="spec module" id="module-Id"><a href="#module-Id" class="anchor"></a><code><span class="keyword">module</span> Id = <a href="../Data__/index.html#module-Data_id">Data__.Data_id</a></code></div></section></div></body></html>