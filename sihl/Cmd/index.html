<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cmd (sihl.Cmd)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">sihl</a> &#x00BB; Cmd</nav><h1>Module <code>Cmd</code></h1><p>Use this module to create your own command line commands in order to interact with the Sihl app.</p><p>Services can register command with the command service. This is why a lot of services have a dependency on it. All the built-in commands are contributed by individual services using this mechanism. Examples for those commands are:</p><ul><li><code>migrate</code> is registered by the migration service and it runs the migrations</li><li><code>start</code> is registered by the web server service and it starts the web server</li><li><code>createadmin</code> is registered by the user service and it creates an admin user, useful to bootstrap your app so you have one user to log in</li></ul><p>You can contribute your custom commands the same way to interact with your app through the CLI. This can be very handy for development and administration. You sometimes want to call services without going through the HTTP stack, authentication, validation and authorization layers.</p><nav class="toc"><ul><li><a href="#usage">Usage</a></li></ul></nav></header><dl><dt class="spec type" id="type-fn"><a href="#type-fn" class="anchor"></a><code><span class="keyword">type</span> fn</code><code> = <span>Base.string Base.list</span> <span>&#45;&gt;</span> <span>Base.unit Lwt.t</span></code></dt></dl><dl><dt class="spec value" id="val-pp_fn"><a href="#val-pp_fn" class="anchor"></a><code><span class="keyword">val</span> pp_fn : Ppx_deriving_runtime.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-fn">fn</a> <span>&#45;&gt;</span> Ppx_deriving_runtime.unit</code></dt><dt class="spec value" id="val-show_fn"><a href="#val-show_fn" class="anchor"></a><code><span class="keyword">val</span> show_fn : <a href="index.html#type-fn">fn</a> <span>&#45;&gt;</span> Ppx_deriving_runtime.string</code></dt></dl><dl><dt class="spec exception" id="exception-Invalid_usage"><a href="#exception-Invalid_usage" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">Invalid_usage</span> <span class="keyword">of</span> Base.string</code></dt></dl><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code><code> = <a href="../Cmd__/Cmd_core/index.html#type-t">Cmd__.Cmd_core.t</a></code></dt></dl><dl><dt class="spec value" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : Ppx_deriving_runtime.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Ppx_deriving_runtime.unit</code></dt><dt class="spec value" id="val-make"><a href="#val-make" class="anchor"></a><code><span class="keyword">val</span> make : <span>name:Base.string</span> <span>&#45;&gt;</span> <span>?&#8288;help:Base.string</span> <span>&#45;&gt;</span> <span>description:Base.string</span> <span>&#45;&gt;</span> <span>fn:<a href="index.html#type-fn">fn</a></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dt class="spec value" id="val-fn"><a href="#val-fn" class="anchor"></a><code><span class="keyword">val</span> fn : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-fn">fn</a></code></dt><dt class="spec value" id="val-description"><a href="#val-description" class="anchor"></a><code><span class="keyword">val</span> description : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Base.string</code></dt><dt class="spec value" id="val-help"><a href="#val-help" class="anchor"></a><code><span class="keyword">val</span> help : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>Base.string Base.option</span></code></dt><dt class="spec value" id="val-name"><a href="#val-name" class="anchor"></a><code><span class="keyword">val</span> name : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Base.string</code></dt><dt class="spec value" id="val-show"><a href="#val-show" class="anchor"></a><code><span class="keyword">val</span> show : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string</code></dt></dl><dl><dt class="spec module" id="module-Service"><a href="#module-Service" class="anchor"></a><code><span class="keyword">module</span> Service = <a href="../Cmd__/index.html#module-Cmd_service">Cmd__.Cmd_service</a></code></dt><dd></dd></dl><section><header><h2 id="usage"><a href="#usage" class="anchor"></a>Usage</h2><p>This is how the command <code>createadmin</code> is implemented:</p><pre><code class="ml">let create_admin_cmd =
  Cmd.make ~name:&quot;createadmin&quot; ~help:&quot;&lt;username&gt; &lt;email&gt; &lt;password&gt;&quot;
    ~description:&quot;Create an admin user&quot;
    ~fn:(fun args -&gt;
      match args with
      | [ username; email; password ] -&gt;
          let ctx = Core.Ctx.empty |&gt; DbService.add_pool in
          User_service.create_admin ctx ~email ~password ~username:(Some username)
          |&gt; Lwt_result.map ignore
      | _ -&gt; Lwt_result.fail &quot;Usage: &lt;username&gt; &lt;email&gt; &lt;password&gt;&quot;)
    ()

let _ =
  App.(empty
  |&gt; with_services services
  |&gt; with_commands [ create_admin_cmd ]
  |&gt; run)</code></pre></header></section></div></body></html>